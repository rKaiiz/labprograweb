<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gestión de Pedidos (Admin) · La Media Docena</title>
  <link rel="stylesheet" href="assets/css/styles.css"/>
  <script defer src="assets/js/data.js"></script>
  <script defer src="assets/js/main.js"></script>
</head>
<body data-page="admin">
  <main class="container">
    <h2 style="text-align:center;margin:0 0 12px">Gestión de Pedidos</h2>

    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <input id="search" class="input" style="max-width:260px" placeholder="Buscar por cliente o folio...">
        <div style="margin-left:auto"></div>
      </div>
      <table class="table">
        <thead>
          <tr><th>Folio</th><th>Cliente</th><th>Hora</th><th>Total</th><th>Estado</th><th class="actions">Acciones</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <script>
  const STATUS = ['En Proceso','Entregado','Cancelado'];
  function ensure(){ if(!$app.isAdmin()){ location.href = 'login.html?next='+encodeURIComponent('admin-pedidos.html'); } }

  function render(){
    const q = document.getElementById('search').value.toLowerCase();
    const tbody = document.getElementById('tbody');
    const list = $app.listOrders().filter(o => String(o.id).includes(q) || (o.customer||'').toLowerCase().includes(q));

    tbody.innerHTML = list.map(o=>`
      <tr>
        <td>#${o.id}</td>
        <td>${o.customer||'Invitado'}</td>
        <td>${new Date(o.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
        <td>${$app.formatCurrency(o.total)}</td>
        <td>
          <select data-status="${o.id}" class="input" style="padding:6px 10px">
            ${STATUS.map(s=>`<option ${s===o.status?'selected':''}>${s}</option>`).join('')}
          </select>
        </td>
        <td class="actions">
          <button class="btn" data-view="${o.id}">Ver detalles</button>
          <button class="btn danger" data-del="${o.id}">Eliminar</button>
        </td>
      </tr>`).join('');

    tbody.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=>{
      if(!confirm('¿Eliminar pedido?')) return;
      const list = $app.listOrders().filter(x=>x.id!==Number(b.dataset.del));
      localStorage.setItem('lmd_orders', JSON.stringify(list));
      render();
    }));

    tbody.querySelectorAll('[data-status]').forEach(sel=> sel.addEventListener('change', ()=>{
      $app.updateOrder(Number(sel.dataset.status), { status: sel.value });
    }));

    tbody.querySelectorAll('[data-view]').forEach(b=> b.addEventListener('click', ()=>{
      const o = $app.listOrders().find(x=>x.id===Number(b.dataset.view));
      alert('Pedido #' + o.id + '\n' + o.items.map(i=>`${i.qty} x ${i.name} (${ $app.formatCurrency(i.price) })`).join('\n'));
    }));
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    ensure();
    document.getElementById('search').addEventListener('input', render);
    render();
    addEventListener('orders:changed', render);
  });
  </script>
</body>
</html>