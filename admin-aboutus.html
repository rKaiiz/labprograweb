<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Acerca de Nosotros (Admin) · La Media Docena</title>

  <link rel="stylesheet" href="assets/css/styles.css"/>

  <!-- Scripts globales (layout, auth, etc.) -->
  <script defer src="assets/js/data.js"></script>
  <script defer src="assets/js/main.js"></script>
</head>
<body data-page="admin">
  <main class="container">

    <!-- Encabezado -->
    <header style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:16px">
      <div>
        <h1 style="margin:0">Acerca de nosotros</h1>
        <p style="margin:4px 0 0;font-size:13px;color:#555;max-width:520px">
          Edita la información institucional que se muestra en la sección "Acerca de nosotros":
          nombre del negocio, descripción, misión y visión.
        </p>
      </div>
      <nav style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn secondary" href="admin.html">← Volver al panel</a>
        <a class="btn secondary" href="acerca.html">Ver página pública</a>
      </nav>
    </header>

    <!-- Vista previa -->
    <section class="card" style="margin-bottom:16px">
      <h2 style="margin-top:0;font-size:15px">Vista previa rápida</h2>
      <div id="preview" style="font-size:14px;color:#333">
        <h3 id="preview-name" style="margin:0 0 4px;font-size:18px">La Media Docena</h3>
        <p id="preview-descripcion" style="margin:0 0 8px;color:#555">
          Cargando información...
        </p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
          <div style="padding:8px;border-radius:10px;background:#fefce8;border:1px solid #fef08a">
            <h4 style="margin:0 0 4px;font-size:14px;color:#854d0e">Misión</h4>
            <p id="preview-mision" style="margin:0;font-size:13px;color:#6b4f1d">
              –
            </p>
          </div>
          <div style="padding:8px;border-radius:10px;background:#eff6ff;border:1px solid #bfdbfe">
            <h4 style="margin:0 0 4px;font-size:14px;color:#1d4ed8">Visión</h4>
            <p id="preview-vision" style="margin:0;font-size:13px;color:#1e3a8a">
              –
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Formulario de edición -->
    <section class="card">
      <h2 style="margin-top:0;font-size:15px">Editar información</h2>

      <form id="aboutForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
        <div style="grid-column:1/-1">
          <label for="nombre">Nombre del negocio *</label>
          <input id="nombre" name="nombre" class="input" required placeholder="Ej. La Media Docena"/>
        </div>

        <div style="grid-column:1/-1">
          <label for="descripcion">Descripción breve *</label>
          <textarea id="descripcion" name="descripcion" class="input" rows="3" required
                    placeholder="Texto que se mostrará como descripción general del negocio."></textarea>
          <p style="margin:4px 0 0;font-size:11px;color:#777">
            Se recomienda un párrafo de 2–4 líneas para que se vea bien tanto en escritorio como en móvil.
          </p>
        </div>

        <div>
          <label for="mision">Misión</label>
          <textarea id="mision" name="mision" class="input" rows="5"
                    placeholder="¿Cuál es el propósito principal de La Media Docena?"></textarea>
        </div>

        <div>
          <label for="vision">Visión</label>
          <textarea id="vision" name="vision" class="input" rows="5"
                    placeholder="¿A dónde quieren llegar como negocio en el futuro?"></textarea>
        </div>

        <div style="grid-column:1/-1;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;margin-top:4px">
          <button type="button" class="btn secondary" id="btn-reset">Restablecer desde BD</button>
          <button type="submit" class="btn">Guardar cambios</button>
        </div>

        <p id="formStatus" style="grid-column:1/-1;font-size:12px;margin:4px 0 0;"></p>
      </form>
    </section>

  </main>

  <script>
    const API_BASE = "http://127.0.0.1:5000/api";

    function setStatus(msg, type = "info") {
      const el = document.getElementById("formStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.style.color = type === "error" ? "#b42318" : "#166534";
    }

    function fillPreview(data) {
      document.getElementById("preview-name").textContent = data.nombre || "La Media Docena";
      document.getElementById("preview-descripcion").textContent =
        data.descripcion || "Agrega una descripción para que tus clientes conozcan mejor el concepto del lugar.";
      document.getElementById("preview-mision").textContent =
        data.mision || "Aún no has definido la misión. Agrega una para comunicar el propósito del negocio.";
      document.getElementById("preview-vision").textContent =
        data.vision || "Aún no has definido la visión. Agrega una para comunicar hacia dónde quieren llegar.";
    }

    function fillForm(data) {
      document.getElementById("nombre").value = data.nombre || "";
      document.getElementById("descripcion").value = data.descripcion || "";
      document.getElementById("mision").value = data.mision || "";
      document.getElementById("vision").value = data.vision || "";
      fillPreview(data);
    }

    async function cargarAbout() {
      setStatus("Cargando información...", "info");
      try {
        const res = await fetch(`${API_BASE}/about`);
        const data = await res.json().catch(() => ({}));

        const about = data && typeof data === "object" ? data : {};
        fillForm(about);
        setStatus("");
      } catch (err) {
        console.error("Error cargando about:", err);
        setStatus("No se pudo cargar la información desde la base de datos.", "error");
      }
    }

    async function guardarAbout(e) {
      e.preventDefault();
      setStatus("");

      const nombre = document.getElementById("nombre").value.trim();
      const descripcion = document.getElementById("descripcion").value.trim();
      const mision = document.getElementById("mision").value.trim();
      const vision = document.getElementById("vision").value.trim();

      if (!nombre || !descripcion) {
        setStatus("Nombre y descripción son obligatorios.", "error");
        return;
      }

      const payload = { nombre, descripcion, mision, vision };

      try {
        const res = await fetch(`${API_BASE}/about`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.ok === false) {
          throw new Error(data.error || "No se pudo guardar la información.");
        }

        setStatus("Información actualizada correctamente.");
        fillPreview(payload);
      } catch (err) {
        console.error("Error guardando about:", err);
        setStatus(err.message || "Ocurrió un error al guardar.", "error");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Si en algún momento agregas $app.requireAdmin, esto lo protegerá
      if (window.$app && typeof $app.requireAdmin === "function") {
        $app.requireAdmin();
      }

      const form = document.getElementById("aboutForm");
      form.addEventListener("submit", guardarAbout);

      document.getElementById("btn-reset").addEventListener("click", () => {
        cargarAbout();
      });

      // Carga inicial
      cargarAbout();
    });
  </script>
</body>
</html>
