<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Administrar reseñas · La Media Docena</title>

  <!-- Estilos globales -->
  <link rel="stylesheet" href="assets/css/styles.css"/>

  <!-- Scripts globales -->
  <script defer src="assets/js/data.js"></script>
  <script defer src="assets/js/main.js"></script>
</head>
<body data-page="admin">
  <main class="container">

    <!-- Encabezado -->
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap">
      <div>
        <h1 style="margin:0">Administrar reseñas</h1>
        <p style="margin:4px 0 0;font-size:13px;color:#555">
          Revisa, aprueba, rechaza o elimina las reseñas que dejan los clientes en La Media Docena.
        </p>
      </div>
      <nav style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn secondary" href="admin.html">← Volver al panel</a>
        <a class="btn secondary" href="resenas.html" target="_blank">Ver página pública</a>
      </nav>
    </header>

    <!-- Filtros -->
    <section class="card" style="margin-bottom:16px">
      <h2 style="margin-top:0;font-size:16px">Filtros</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;align-items:flex-end">
        <div>
          <label for="filtro-estado">Estado</label>
          <select id="filtro-estado" class="input">
            <option value="">Todos</option>
            <option value="pendiente">Pendientes</option>
            <option value="aprobada">Aprobadas</option>
            <option value="rechazada">Rechazadas</option>
          </select>
        </div>
        <div>
          <label for="filtro-texto">Buscar por nombre o comentario</label>
          <input
            id="filtro-texto"
            class="input"
            placeholder="Ej. nombre del cliente o parte del comentario"
          >
        </div>
      </div>
      <p id="res-admin-resumen" style="margin-top:8px;font-size:12px;color:#777">
        Cargando reseñas...
      </p>
    </section>

    <!-- Tabla de reseñas -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <h2 style="margin:0;font-size:16px">Reseñas registradas</h2>
        <button class="btn secondary" type="button" id="btn-recargar">
          Recargar
        </button>
      </div>

      <div id="res-admin-msg" style="margin-bottom:8px;font-size:13px;display:none"></div>

      <div style="overflow-x:auto;max-height:420px">
        <table class="table" style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr>
              <th style="text-align:left;padding:4px;border-bottom:1px solid #eee">ID</th>
              <th style="text-align:left;padding:4px;border-bottom:1px solid #eee">Nombre</th>
              <th style="text-align:left;padding:4px;border-bottom:1px solid #eee">Calificación</th>
              <th style="text-align:left;padding:4px;border-bottom:1px solid #eee">Comentario</th>
              <th style="text-align:left;padding:4px;border-bottom:1px solid #eee">Fecha/Hora</th>
              <th style="text-align:center;padding:4px;border-bottom:1px solid #eee">Estado</th>
              <th style="text-align:center;padding:4px;border-bottom:1px solid #eee">Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-resenas-admin">
            <tr>
              <td colspan="7" style="padding:6px;text-align:center;font-size:12px;color:#777">
                Cargando reseñas...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    const API_BASE = "http://127.0.0.1:5000/api";

    let resenasCache = [];

    function estrellasTexto(calificacion){
      const n = Math.max(0, Math.min(5, Number(calificacion || 0)));
      return "★".repeat(n) + "☆".repeat(5 - n);
    }

    function setAdminMsg(texto, tipo = "info"){
      const box = document.getElementById("res-admin-msg");
      if(!box) return;
      if(!texto){
        box.style.display = "none";
        box.textContent = "";
        return;
      }
      box.style.display = "block";
      box.textContent = texto;
      if(tipo === "ok"){
        box.style.color = "#1a7f37";
      } else if(tipo === "error"){
        box.style.color = "#b42318";
      } else {
        box.style.color = "#555";
      }
    }

    function aplicarFiltrosResenas(){
      const estadoSel = document.getElementById("filtro-estado").value;
      const texto = document.getElementById("filtro-texto").value.trim().toLowerCase();

      return resenasCache.filter(r => {
        if(estadoSel && r.estado !== estadoSel) return false;

        if(texto){
          const nombre = (r.nombre || "").toLowerCase();
          const comentario = (r.comentario || "").toLowerCase();
          if(!nombre.includes(texto) && !comentario.includes(texto)) return false;
        }

        return true;
      });
    }

    function badgeEstado(estado){
      const e = estado || "pendiente";
      let colorBg = "#fef3c7";
      let colorText = "#92400e";
      if(e === "aprobada"){ colorBg = "#e6f4ea"; colorText = "#137333"; }
      if(e === "rechazada"){ colorBg = "#fde7e7"; colorText = "#b42318"; }

      return `
        <span style="
          display:inline-block;
          font-size:11px;
          padding:2px 7px;
          border-radius:999px;
          background:${colorBg};
          color:${colorText};
          border:1px solid rgba(0,0,0,0.06);
        ">
          ${e}
        </span>
      `;
    }

    function renderTablaResenas(){
      const tbody = document.getElementById("tabla-resenas-admin");
      const resumen = document.getElementById("res-admin-resumen");
      if(!tbody || !resumen) return;

      const filtradas = aplicarFiltrosResenas();

      tbody.innerHTML = "";

      if(!resenasCache.length){
        resumen.textContent = "No hay reseñas registradas en el sistema.";
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="padding:6px;text-align:center;font-size:12px;color:#777">
              No hay reseñas en la base de datos.
            </td>
          </tr>
        `;
        return;
      }

      resumen.textContent = filtradas.length
        ? `${filtradas.length} reseña(s) mostrada(s) con los filtros actuales. Total en sistema: ${resenasCache.length}.`
        : `No se encontraron reseñas con esos filtros. Total en sistema: ${resenasCache.length}.`;

      if(!filtradas.length){
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="padding:6px;text-align:center;font-size:12px;color:#777">
              No se encontraron reseñas con los filtros aplicados.
            </td>
          </tr>
        `;
        return;
      }

      // Ordenar por fecha desc si hay ts
      const lista = filtradas.slice().sort((a,b)=>{
        const ta = a.ts || "";
        const tb = b.ts || "";
        if(tb > ta) return 1;
        if(tb < ta) return -1;
        return 0;
      });

      lista.forEach(r => {
        const tr = document.createElement("tr");
        const estrellas = estrellasTexto(r.calificacion);
        const nombre = r.nombre || "Anónimo";
        const comentario = r.comentario || "";
        const fecha = r.ts || "";

        tr.innerHTML = `
          <td style="padding:4px;border-bottom:1px solid #eee">${r.id}</td>
          <td style="padding:4px;border-bottom:1px solid #eee">
            <strong>${nombre}</strong>
          </td>
          <td style="padding:4px;border-bottom:1px solid #eee">
            <div style="font-size:13px;color:#f5a623">${estrellas}</div>
            <div style="font-size:11px;color:#777">${r.calificacion || 0} / 5</div>
          </td>
          <td style="padding:4px;border-bottom:1px solid #eee;font-size:12px;color:#444;max-width:280px">
            ${comentario}
          </td>
          <td style="padding:4px;border-bottom:1px solid #eee;font-size:11px;color:#777">
            ${fecha}
          </td>
          <td style="padding:4px;border-bottom:1px solid #eee;text-align:center">
            ${badgeEstado(r.estado)}
          </td>
          <td style="padding:4px;border-bottom:1px solid #eee;text-align:center;font-size:11px">
            <button
              class="btn secondary btn-estado"
              type="button"
              data-id="${r.id}"
              data-estado="aprobada"
              style="padding:2px 6px;margin:1px"
            >Aprobar</button>
            <button
              class="btn secondary btn-estado"
              type="button"
              data-id="${r.id}"
              data-estado="rechazada"
              style="padding:2px 6px;margin:1px"
            >Rechazar</button>
            <button
              class="btn secondary btn-estado"
              type="button"
              data-id="${r.id}"
              data-estado="pendiente"
              style="padding:2px 6px;margin:1px"
            >Pendiente</button>
            <button
              class="btn secondary btn-eliminar"
              type="button"
              data-id="${r.id}"
              style="padding:2px 6px;margin:1px"
            >Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function cargarResenas(){
      const tbody = document.getElementById("tabla-resenas-admin");
      const resumen = document.getElementById("res-admin-resumen");
      if(tbody){
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="padding:6px;text-align:center;font-size:12px;color:#777">
              Cargando reseñas...
            </td>
          </tr>
        `;
      }
      if(resumen){
        resumen.textContent = "Cargando reseñas...";
      }
      setAdminMsg("");

      try{
        const res = await fetch(`${API_BASE}/resenas`);
        const data = await res.json().catch(()=>[]);
        resenasCache = Array.isArray(data) ? data : [];
        renderTablaResenas();
      }catch(err){
        console.error("Error cargando reseñas:", err);
        setAdminMsg("No se pudieron cargar las reseñas. Verifica que el backend esté activo.", "error");
        if(tbody){
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="padding:6px;text-align:center;font-size:12px;color:#b42318">
                Error al cargar las reseñas.
              </td>
            </tr>
          `;
        }
        if(resumen){
          resumen.textContent = "No se pudieron cargar las reseñas.";
        }
      }
    }

    async function actualizarEstadoResena(id, nuevoEstado){
      setAdminMsg("Actualizando estado de la reseña...", "info");
      try{
        const res = await fetch(`${API_BASE}/resenas/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ estado: nuevoEstado })
        });
        const data = await res.json().catch(()=>({}));

        if(!res.ok || data.ok === false){
          console.error("Error al actualizar reseña:", data);
          setAdminMsg(data.error || "No se pudo actualizar el estado de la reseña.", "error");
          return;
        }

        // Actualizar en cache sin recargar todo
        const r = resenasCache.find(x => x.id === id);
        if(r) r.estado = nuevoEstado;
        setAdminMsg("Estado de la reseña actualizado correctamente.", "ok");
        renderTablaResenas();
      }catch(err){
        console.error("Error al conectar con el servidor:", err);
        setAdminMsg("Error al conectar con el servidor.", "error");
      }
    }

    async function eliminarResena(id){
      if(!confirm("¿Seguro que deseas eliminar esta reseña? Esta acción no se puede deshacer.")){
        return;
      }
      setAdminMsg("Eliminando reseña...", "info");
      try{
        const res = await fetch(`${API_BASE}/resenas/${id}`, {
          method: "DELETE"
        });
        const data = await res.json().catch(()=>({}));

        if(!res.ok || data.ok === false){
          console.error("Error al eliminar reseña:", data);
          setAdminMsg(data.error || "No se pudo eliminar la reseña.", "error");
          return;
        }

        resenasCache = resenasCache.filter(r => r.id !== id);
        setAdminMsg("Reseña eliminada correctamente.", "ok");
        renderTablaResenas();
      }catch(err){
        console.error("Error al conectar con el servidor:", err);
        setAdminMsg("Error al conectar con el servidor.", "error");
      }
    }

    function manejarClickTabla(e){
      const btnEstado = e.target.closest(".btn-estado");
      const btnEliminar = e.target.closest(".btn-eliminar");

      if(btnEstado){
        const id = parseInt(btnEstado.dataset.id, 10);
        const estado = btnEstado.dataset.estado;
        if(!isNaN(id) && estado){
          actualizarEstadoResena(id, estado);
        }
      }

      if(btnEliminar){
        const id = parseInt(btnEliminar.dataset.id, 10);
        if(!isNaN(id)){
          eliminarResena(id);
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Proteger: solo admin
      if(window.$app && typeof $app.requireAdmin === "function"){
        $app.requireAdmin();
      }

      const tbody = document.getElementById("tabla-resenas-admin");
      const filtroEstado = document.getElementById("filtro-estado");
      const filtroTexto = document.getElementById("filtro-texto");
      const btnRecargar = document.getElementById("btn-recargar");

      if(tbody){
        tbody.addEventListener("click", manejarClickTabla);
      }
      if(filtroEstado){
        filtroEstado.addEventListener("change", renderTablaResenas);
      }
      if(filtroTexto){
        filtroTexto.addEventListener("input", () => {
          renderTablaResenas();
        });
      }
      if(btnRecargar){
        btnRecargar.addEventListener("click", cargarResenas);
      }

      cargarResenas();
    });
  </script>
</body>
</html>
